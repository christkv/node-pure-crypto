var debug = require('sys').debug;
var inspect = require('sys').inspect;
var util = require('utils');
var Long = require('long').Long;

// TreeFish Implementation in Javascript
// const BlockSize = 16;
const KEY_SCHEDULE_CONST = Long.fromString('1BD11BDAA9FC1A22', 16);
const EXPANDED_TWEAK_SIZE = 3;

var TreeFish = exports.TreeFish = function(key, tweaks) {
  if(Array.isArray(key)) key = util.toHex(key);
  if(Array.isArray(tweaks)) tweaks = util.toHex(tweaks);  
  // Validate correct key size
  if(key.length != 64 && key.length != 128 && key.length != 256) throw "Key must be either 256/512/1024 bits";
  if(tweaks.length != 32) throw "Tweaks must be 128 bits";

  // Parse the longs
  tweaks = [Long.fromString(tweaks.slice(0, 16), 16),
    Long.fromString(tweaks.slice(16, 32), 16)]
  // Create tweek array
  this.expandedTweak = new Array(EXPANDED_TWEAK_SIZE);
  // Expand the tweak
  this.expandedTweak[0] = tweaks[0];
  this.expandedTweak[1] = tweaks[1];
  this.expandedTweak[2] = tweaks[0].xor(tweaks[1]);

  // Set statesize
  this.stateSize = key.length;

  // Base variables(defaulted to 256 bit key)
  if(key.length == 64) {
    this.CIPHER_SIZE = 256;
    this.CIPHER_QWORDS = this.CIPHER_SIZE / 64;
    this.EXPANDED_KEY_SIZE = this.CIPHER_QWORDS + 1;    
  }

  this.BlockSize = this.CIPHER_SIZE / 8;
  // Create space for key
  this.expanedKey = new Array(this.EXPANDED_KEY_SIZE);
  this.expanedKey[this.EXPANDED_KEY_SIZE - 1] = KEY_SCHEDULE_CONST;
  this.cipherIn = new Array(this.stateSize / 64);
  this.cipherOut = new Array(this.stateSize / 64);
  
  // Set key
  var i = 0;
  var parity = KEY_SCHEDULE_CONST;
  
  for(i = 0; i < this.expanedKey.length - 1; i++) {
    this.expanedKey[i] = Long.fromString(key.slice(i*16, i*16 + 16), 16);
    parity = parity.xor(this.expanedKey[i]);
  }
  
  this.expanedKey[i] = parity;  
}

TreeFish.prototype.getBlockSize = function() {
  return BlockSize;
}

TreeFish.prototype.encrypt = function(src, index) {
  index = index == null ? 0 : index;

  if(this.CIPHER_SIZE == 256) {
    return this.encryptBlock256(src.slice(index, index + this.BlockSize));
  }
  
  // return this.encryptBlock(src.slice(index, index + BlockSize));
}

TreeFish.prototype.encryptBlock256 = function(input) {
  if(Array.isArray(input)) input = util.toHex(input);
  // Unpack variables
  var b0 = Long.fromString(input.slice(0, 16), 16);
  var b1 = Long.fromString(input.slice(16, 32), 16);
  var b2 = Long.fromString(input.slice(32, 48), 16);
  var b3 = Long.fromString(input.slice(48, 64), 16);
  // Unpack key
  var k0 = this.expanedKey[0];
  var k1 = this.expanedKey[1];
  var k2 = this.expanedKey[2];
  var k3 = this.expanedKey[3];
  var k4 = this.expanedKey[4];
  // Unpack tweak
  var t0 = this.expandedTweak[0];
  var t1 = this.expandedTweak[1];
  var t2 = this.expandedTweak[2];
  
  b1 = b1.add(k1.add(t0));
  b0 = b0.add(b1.add(k0));
  b1 = b1.shiftLeft(14).or(b1.shiftRightUnsigned(64 - 14)).xor(b0);  
  b3 = b3.add(k3);
  b2 = b2.add(b3.add(k2).add(t1));
  b3 = b3.shiftLeft(16).or(b3.shiftRightUnsigned(64 - 16)).xor(b2);
  b0 = b0.add(b3);
  b3 = b3.shiftLeft(52).or(b3.shiftRightUnsigned(64 - 52)).xor(b0);
  b2 = b2.add(b1);
  b1 = b1.shiftLeft(57).or(b1.shiftRightUnsigned(64 - 57)).xor(b2);
  b0 = b0.add(b1);
  b1 = b1.shiftLeft(23).or(b1.shiftRightUnsigned(64 - 23)).xor(b0);
  b2 = b2.add(b3);
  b3 = b3.shiftLeft(40).or(b3.shiftRightUnsigned(64 - 40)).xor(b2);
  b0 = b0.add(b3);
  b3 = b3.shiftLeft(5).or(b3.shiftRightUnsigned(64 - 5)).xor(b0);
  b2 = b2.add(b1);
  b1 = b1.shiftLeft(37).or(b1.shiftRightUnsigned(64 - 37)).xor(b2);
  b1 = b1.add(k2.add(t1));
  b0 = b0.add(b1.add(k1));
  b1 = b1.shiftLeft(25).or(b1.shiftRightUnsigned(64 - 25)).xor(b0);
  b3 = b3.add(k4).add(Long.fromNumber(1));
  b2 = b2.add(b3).add(k3).add(t2);
  b3 = b3.shiftLeft(33).or(b3.shiftRightUnsigned(64 - 33)).xor(b2);
  b0 = b0.add(b3);
  b3 = b3.shiftLeft(46).or(b3.shiftRightUnsigned(64 - 46)).xor(b0);
  b2 = b2.add(b1);
  b1 = b1.shiftLeft(12).or(b1.shiftRightUnsigned(64 - 12)).xor(b2);
  b0 = b0.add(b1);
  b1 = b1.shiftLeft(58).or(b1.shiftRightUnsigned(64 - 58)).xor(b0);
  b2 = b2.add(b3);
  b3 = b3.shiftLeft(22).or(b3.shiftRightUnsigned(64 - 22)).xor(b2);
  b0 = b0.add(b3);
  b3 = b3.shiftLeft(32).or(b3.shiftRightUnsigned(64 - 32)).xor(b0);
  b2 = b2.add(b1);
  b1 = b1.shiftLeft(32).or(b1.shiftRightUnsigned(64 - 32)).xor(b2);

  b1 = b1.add(k3).add(t2);
  b0 = b0.add(b1).add(k2);
  b1 = b1.shiftLeft(14).or(b1.shiftRightUnsigned(64 - 14)).xor(b0);
  b3 = b3.add(k0).add(Long.fromNumber(2));
  b2 = b2.add(b3).add(k4).add(t0);  
  b3 = b3.shiftLeft(16).or(b3.shiftRightUnsigned(64 - 16)).xor(b2);
  b0 = b0.add(b3);
  b3 = b3.shiftLeft(52).or(b3.shiftRightUnsigned(64 - 52)).xor(b0);
  b2 = b2.add(b1);
  b1 = b1.shiftLeft(57).or(b1.shiftRightUnsigned(64 - 57)).xor(b2);
  b0 = b0.add(b1);
  b1 = b1.shiftLeft(23).or(b1.shiftRightUnsigned(64 - 23)).xor(b0);
  b2 = b2.add(b3);
  b3 = b3.shiftLeft(40).or(b3.shiftRightUnsigned(64 - 40)).xor(b2);
  b0 = b0.add(b3);
  b3 = b3.shiftLeft(5).or(b3.shiftRightUnsigned(64 - 5)).xor(b0);
  b2 = b2.add(b1);
  b1 = b1.shiftLeft(37).or(b1.shiftRightUnsigned(64 - 37)).xor(b2);
  b1 = b1.add(k4).add(t0);  
  b0 = b0.add(b1).add(k3);  
  b1 = b1.shiftLeft(25).or(b1.shiftRightUnsigned(64 - 25)).xor(b0);
  b3 = b3.add(k1).add(Long.fromNumber(3));
  b2 = b2.add(b3).add(k0).add(t1);  
  b3 = b3.shiftLeft(33).or(b3.shiftRightUnsigned(64 - 33)).xor(b2);
  b0 = b0.add(b3);
  b3 = b3.shiftLeft(46).or(b3.shiftRightUnsigned(64 - 46)).xor(b0);
  b2 = b2.add(b1);
  b1 = b1.shiftLeft(12).or(b1.shiftRightUnsigned(64 - 12)).xor(b2);
  b0 = b0.add(b1);
  b1 = b1.shiftLeft(58).or(b1.shiftRightUnsigned(64 - 58)).xor(b0);
  b2 = b2.add(b3);
  b3 = b3.shiftLeft(22).or(b3.shiftRightUnsigned(64 - 22)).xor(b2);
  b0 = b0.add(b3);
  b3 = b3.shiftLeft(32).or(b3.shiftRightUnsigned(64 - 32)).xor(b0);
  b2 = b2.add(b1);
  b1 = b1.shiftLeft(32).or(b1.shiftRightUnsigned(64 - 32)).xor(b2);

  b1 = b1.add(k0).add(t1);
  b0 = b0.add(b1).add(k4);
  b1 = b1.shiftLeft(14).or(b1.shiftRightUnsigned(64 - 14)).xor(b0);
  b3 = b3.add(k2).add(Long.fromNumber(4));
  b2 = b2.add(b3).add(k1).add(t2);
  b3 = b3.shiftLeft(16).or(b3.shiftRightUnsigned(64 - 16)).xor(b2);
  b0 = b0.add(b3);
  b3 = b3.shiftLeft(52).or(b3.shiftRightUnsigned(64 - 52)).xor(b0);
  b2 = b2.add(b1);
  b1 = b1.shiftLeft(57).or(b1.shiftRightUnsigned(64 - 57)).xor(b2);
  b0 = b0.add(b1);
  b1 = b1.shiftLeft(23).or(b1.shiftRightUnsigned(64 - 23)).xor(b0);
  b2 = b2.add(b3);
  b3 = b3.shiftLeft(40).or(b3.shiftRightUnsigned(64 - 40)).xor(b2);
  b0 = b0.add(b3);
  b3 = b3.shiftLeft(5).or(b3.shiftRightUnsigned(64 - 5)).xor(b0);
  b2 = b2.add(b1);
  b1 = b1.shiftLeft(37).or(b1.shiftRightUnsigned(64 - 37)).xor(b2);
  b1 = b1.add(k1).add(t2);
  b0 = b0.add(b1).add(k0);
  b1 = b1.shiftLeft(25).or(b1.shiftRightUnsigned(64 - 25)).xor(b0);
  b3 = b3.add(k3).add(Long.fromNumber(5));
  b2 = b2.add(b3).add(k2).add(t0);
  b3 = b3.shiftLeft(33).or(b3.shiftRightUnsigned(64 - 33)).xor(b2);
  b0 = b0.add(b3);
  b3 = b3.shiftLeft(46).or(b3.shiftRightUnsigned(64 - 46)).xor(b0);
  b2 = b2.add(b1);
  b1 = b1.shiftLeft(12).or(b1.shiftRightUnsigned(64 - 12)).xor(b2);
  b0 = b0.add(b1);
  b1 = b1.shiftLeft(58).or(b1.shiftRightUnsigned(64 - 58)).xor(b0);
  b2 = b2.add(b3);
  b3 = b3.shiftLeft(22).or(b3.shiftRightUnsigned(64 - 22)).xor(b2);
  b0 = b0.add(b3);
  b3 = b3.shiftLeft(32).or(b3.shiftRightUnsigned(64 - 32)).xor(b0);
  b2 = b2.add(b1);
  b1 = b1.shiftLeft(32).or(b1.shiftRightUnsigned(64 - 32)).xor(b2);

  b1 = b1.add(k2).add(t0);
  b0 = b0.add(b1).add(k1);
  b1 = b1.shiftLeft(14).or(b1.shiftRightUnsigned(64 - 14)).xor(b0);
  b3 = b3.add(k4).add(Long.fromNumber(6));
  b2 = b2.add(b3).add(k3).add(t1);
  b3 = b3.shiftLeft(16).or(b3.shiftRightUnsigned(64 - 16)).xor(b2);
  b0 = b0.add(b3);
  b3 = b3.shiftLeft(52).or(b3.shiftRightUnsigned(64 - 52)).xor(b0);
  b2 = b2.add(b1);
  b1 = b1.shiftLeft(57).or(b1.shiftRightUnsigned(64 - 57)).xor(b2);
  b0 = b0.add(b1);
  b1 = b1.shiftLeft(23).or(b1.shiftRightUnsigned(64 - 23)).xor(b0);
  b2 = b2.add(b3);
  b3 = b3.shiftLeft(40).or(b3.shiftRightUnsigned(64 - 40)).xor(b2);
  b0 = b0.add(b3);
  b3 = b3.shiftLeft(5).or(b3.shiftRightUnsigned(64 - 5)).xor(b0);
  b2 = b2.add(b1);
  b1 = b1.shiftLeft(37).or(b1.shiftRightUnsigned(64 - 37)).xor(b2);
  b1 = b1.add(k3).add(t1);
  b0 = b0.add(b1).add(k2);
  b1 = b1.shiftLeft(25).or(b1.shiftRightUnsigned(64 - 25)).xor(b0);
  b3 = b3.add(k0).add(Long.fromNumber(7));
  b2 = b2.add(b3).add(k4).add(t2);
  b3 = b3.shiftLeft(33).or(b3.shiftRightUnsigned(64 - 33)).xor(b2);
  b0 = b0.add(b3);
  b3 = b3.shiftLeft(46).or(b3.shiftRightUnsigned(64 - 46)).xor(b0);
  b2 = b2.add(b1);
  b1 = b1.shiftLeft(12).or(b1.shiftRightUnsigned(64 - 12)).xor(b2);
  b0 = b0.add(b1);
  b1 = b1.shiftLeft(58).or(b1.shiftRightUnsigned(64 - 58)).xor(b0);
  b2 = b2.add(b3);
  b3 = b3.shiftLeft(22).or(b3.shiftRightUnsigned(64 - 22)).xor(b2);
  b0 = b0.add(b3);
  b3 = b3.shiftLeft(32).or(b3.shiftRightUnsigned(64 - 32)).xor(b0);
  b2 = b2.add(b1);
  b1 = b1.shiftLeft(32).or(b1.shiftRightUnsigned(64 - 32)).xor(b2);
  b1 = b1.add(k4).add(t2);
  b0 = b0.add(b1).add(k3);
  b1 = b1.shiftLeft(14).or(b1.shiftRightUnsigned(64 - 14)).xor(b0);

  b3 = b3.add(k1).add(Long.fromNumber(8));
  b2 = b2.add(b3).add(k0).add(t0);
  b3 = b3.shiftLeft(16).or(b3.shiftRightUnsigned(64 - 16)).xor(b2);
  b0 = b0.add(b3);
  b3 = b3.shiftLeft(52).or(b3.shiftRightUnsigned((64 - 52))).xor(b0);
  b2 = b2.add(b1);
  b1 = b1.shiftLeft(57).or(b1.shiftRightUnsigned((64 - 57))).xor(b2);
  b0 = b0.add(b1);
  b1 = b1.shiftLeft(23).or(b1.shiftRightUnsigned((64 - 23))).xor(b0);
  b2 = b2.add(b3);
  b3 = b3.shiftLeft(40).or(b3.shiftRightUnsigned((64 - 40))).xor(b2);
  b0 = b0.add(b3);
  b3 = b3.shiftLeft(5).or(b3.shiftRightUnsigned((64 - 5))).xor(b0);
  b2 = b2.add(b1);
  b1 = b1.shiftLeft(37).or(b1.shiftRightUnsigned((64 - 37))).xor(b2);
  b1 = b1.add(k0).add(t0);
  b0 = b0.add(b1).add(k4);
  b1 = b1.shiftLeft(25).or(b1.shiftRightUnsigned((64 - 25))).xor(b0);
  b3 = b3.add(k2).add(Long.fromNumber(9));
  b2 = b2.add(b3).add(k1).add(t1);
  b3 = b3.shiftLeft(33).or(b3.shiftRightUnsigned((64 - 33))).xor(b2);
  b0 = b0.add(b3);
  b3 = b3.shiftLeft(46).or(b3.shiftRightUnsigned((64 - 46))).xor(b0);
  b2 = b2.add(b1);
  b1 = b1.shiftLeft(12).or(b1.shiftRightUnsigned((64 - 12))).xor(b2);
  b0 = b0.add(b1);
  b1 = b1.shiftLeft(58).or(b1.shiftRightUnsigned((64 - 58))).xor(b0);
  b2 = b2.add(b3);
  b3 = b3.shiftLeft(22).or(b3.shiftRightUnsigned((64 - 22))).xor(b2);
  b0 = b0.add(b3);
  b3 = b3.shiftLeft(32).or(b3.shiftRightUnsigned((64 - 32))).xor(b0);
  b2 = b2.add(b1);
  b1 = b1.shiftLeft(32).or(b1.shiftRightUnsigned((64 - 32))).xor(b2);
  b1 = b1.add(k1).add(t1);
  b0 = b0.add(b1).add(k0);
  b1 = (b1).shiftLeft(14).or(b1.shiftRightUnsigned((64 - 14))).xor(b0);

  b3 = b3.add(k3).add(Long.fromNumber(10));
  b2 = b2.add(b3).add(k2).add(t2);
  b3 = (b3).shiftLeft(16).or(b3.shiftRightUnsigned((64 - 16))).xor(b2);
  b0 = b0.add(b3);
  b3 = (b3).shiftLeft(52).or(b3.shiftRightUnsigned((64 - 52))).xor(b0);
  b2 = b2.add(b1);
  b1 = (b1).shiftLeft(57).or(b1.shiftRightUnsigned((64 - 57))).xor(b2);
  b0 = b0.add(b1);
  b1 = (b1).shiftLeft(23).or(b1.shiftRightUnsigned((64 - 23))).xor(b0);
  b2 = b2.add(b3);
  b3 = (b3).shiftLeft(40).or(b3.shiftRightUnsigned((64 - 40))).xor(b2);
  b0 = b0.add(b3);
  b3 = (b3).shiftLeft(5).or(b3.shiftRightUnsigned((64 - 5))).xor(b0);
  b2 = b2.add(b1);
  b1 = (b1).shiftLeft(37).or(b1.shiftRightUnsigned((64 - 37))).xor(b2);

  b1 = b1.add(k2).add(t2);
  b0 = b0.add(b1).add(k1);
  b1 = (b1).shiftLeft(25).or(b1.shiftRightUnsigned((64 - 25))).xor(b0);
  b3 = b3.add(k4).add(Long.fromNumber(11));
  b2 = b2.add(b3).add(k3).add(t0);
  b3 = (b3).shiftLeft(33).or(b3.shiftRightUnsigned((64 - 33))).xor(b2);
  b0 = b0.add(b3);
  b3 = (b3).shiftLeft(46).or(b3.shiftRightUnsigned((64 - 46))).xor(b0);
  b2 = b2.add(b1);
  b1 = (b1).shiftLeft(12).or(b1.shiftRightUnsigned((64 - 12))).xor(b2);
  b0 = b0.add(b1);
  b1 = (b1).shiftLeft(58).or(b1.shiftRightUnsigned((64 - 58))).xor(b0);
  b2 = b2.add(b3);
  b3 = (b3).shiftLeft(22).or(b3.shiftRightUnsigned((64 - 22))).xor(b2);
  b0 = b0.add(b3);
  b3 = (b3).shiftLeft(32).or(b3.shiftRightUnsigned((64 - 32))).xor(b0);
  b2 = b2.add(b1);
  b1 = (b1).shiftLeft(32).or(b1.shiftRightUnsigned((64 - 32))).xor(b2);

  b1 = b1.add(k3).add(t0);
  b0 = b0.add(b1).add(k2);
  b1 = (b1).shiftLeft(14).or(b1.shiftRightUnsigned((64 - 14))).xor(b0);
  b3 = b3.add(k0).add(Long.fromNumber(12));
  b2 = b2.add(b3).add(k4).add(t1);
  b3 = (b3).shiftLeft(16).or(b3.shiftRightUnsigned((64 - 16))).xor(b2);
  b0 = b0.add(b3);
  b3 = (b3).shiftLeft(52).or(b3.shiftRightUnsigned((64 - 52))).xor(b0);
  b2 = b2.add(b1);
  b1 = (b1).shiftLeft(57).or(b1.shiftRightUnsigned((64 - 57))).xor(b2);
  b0 = b0.add(b1);
  b1 = (b1).shiftLeft(23).or(b1.shiftRightUnsigned((64 - 23))).xor(b0);
  b2 = b2.add(b3);
  b3 = (b3).shiftLeft(40).or(b3.shiftRightUnsigned((64 - 40))).xor(b2);
  b0 = b0.add(b3);
  b3 = (b3).shiftLeft(5).or(b3.shiftRightUnsigned((64 - 5))).xor(b0);
  b2 = b2.add(b1);
  b1 = (b1).shiftLeft(37).or(b1.shiftRightUnsigned((64 - 37))).xor(b2);
  b1 = b1.add(k4).add(t1);
  b0 = b0.add(b1).add(k3);
  b1 = (b1).shiftLeft(25).or(b1.shiftRightUnsigned((64 - 25))).xor(b0);
  b3 = b3.add(k1).add(Long.fromNumber(13));
  b2 = b2.add(b3).add(k0).add(t2);
  b3 = (b3).shiftLeft(33).or(b3.shiftRightUnsigned((64 - 33))).xor(b2);
  b0 = b0.add(b3);
  b3 = (b3).shiftLeft(46).or(b3.shiftRightUnsigned((64 - 46))).xor(b0);
  b2 = b2.add(b1);
  b1 = (b1).shiftLeft(12).or(b1.shiftRightUnsigned((64 - 12))).xor(b2);
  b0 = b0.add(b1);
  b1 = (b1).shiftLeft(58).or(b1.shiftRightUnsigned((64 - 58))).xor(b0);
  b2 = b2.add(b3);
  b3 = (b3).shiftLeft(22).or(b3.shiftRightUnsigned((64 - 22))).xor(b2);
  b0 = b0.add(b3);
  b3 = (b3).shiftLeft(32).or(b3.shiftRightUnsigned((64 - 32))).xor(b0);
  b2 = b2.add(b1);
  b1 = (b1).shiftLeft(32).or(b1.shiftRightUnsigned((64 - 32))).xor(b2);

  b1 = b1.add(k0).add(t2);
  b0 = b0.add(b1).add(k4);
  b1 = (b1).shiftLeft(14).or(b1.shiftRightUnsigned((64 - 14))).xor(b0);
  b3 = b3.add(k2).add(Long.fromNumber(14));
  b2 = b2.add(b3).add(k1).add(t0);
  b3 = (b3).shiftLeft(16).or(b3.shiftRightUnsigned((64 - 16))).xor(b2);
  b0 = b0.add(b3);
  b3 = (b3).shiftLeft(52).or(b3.shiftRightUnsigned((64 - 52))).xor(b0);
  b2 = b2.add(b1);
  b1 = (b1).shiftLeft(57).or(b1.shiftRightUnsigned((64 - 57))).xor(b2);
  b0 = b0.add(b1);
  b1 = (b1).shiftLeft(23).or(b1.shiftRightUnsigned((64 - 23))).xor(b0);
  b2 = b2.add(b3);
  b3 = (b3).shiftLeft(40).or(b3.shiftRightUnsigned((64 - 40))).xor(b2);
  b0 = b0.add(b3);
  b3 = (b3).shiftLeft(5).or(b3.shiftRightUnsigned((64 - 5))).xor(b0);
  b2 = b2.add(b1);
  b1 = (b1).shiftLeft(37).or(b1.shiftRightUnsigned((64 - 37))).xor(b2);
  b1 = b1.add(k1).add(t0);
  b0 = b0.add(b1).add(k0);
  b1 = (b1).shiftLeft(25).or(b1.shiftRightUnsigned((64 - 25))).xor(b0);
  b3 = b3.add(k3).add(Long.fromNumber(15));
  b2 = b2.add(b3).add(k2).add(t1);
  b3 = (b3).shiftLeft(33).or(b3.shiftRightUnsigned((64 - 33))).xor(b2);
  b0 = b0.add(b3);
  b3 = (b3).shiftLeft(46).or(b3.shiftRightUnsigned((64 - 46))).xor(b0);
  b2 = b2.add(b1);
  b1 = (b1).shiftLeft(12).or(b1.shiftRightUnsigned((64 - 12))).xor(b2);
  b0 = b0.add(b1);
  b1 = (b1).shiftLeft(58).or(b1.shiftRightUnsigned((64 - 58))).xor(b0);
  b2 = b2.add(b3);
  b3 = (b3).shiftLeft(22).or(b3.shiftRightUnsigned((64 - 22))).xor(b2);
  b0 = b0.add(b3);
  b3 = (b3).shiftLeft(32).or(b3.shiftRightUnsigned((64 - 32))).xor(b0);
  b2 = b2.add(b1);
  b1 = (b1).shiftLeft(32).or(b1.shiftRightUnsigned((64 - 32))).xor(b2);  
  
  b1 = b1.add(k2).add(t1);
  b0 = b0.add(b1).add(k1);
  b1 = (b1).shiftLeft(14).or(b1.shiftRightUnsigned((64 - 14))).xor(b0);
  b3 = b3.add(k4).add(Long.fromNumber(16));
  b2 = b2.add(b3).add(k3).add(t2);
  b3 = (b3).shiftLeft(16).or(b3.shiftRightUnsigned((64 - 16))).xor(b2);
  b0 = b0.add(b3);
  b3 = (b3).shiftLeft(52).or(b3.shiftRightUnsigned((64 - 52))).xor(b0);
  b2 = b2.add(b1);
  b1 = (b1).shiftLeft(57).or(b1.shiftRightUnsigned((64 - 57))).xor(b2);
  b0 = b0.add(b1);
  b1 = (b1).shiftLeft(23).or(b1.shiftRightUnsigned((64 - 23))).xor(b0);
  b2 = b2.add(b3);
  b3 = (b3).shiftLeft(40).or(b3.shiftRightUnsigned((64 - 40))).xor(b2);
  b0 = b0.add(b3);
  b3 = (b3).shiftLeft(5).or(b3.shiftRightUnsigned((64 - 5))).xor(b0);
  b2 = b2.add(b1);
  b1 = (b1).shiftLeft(37).or(b1.shiftRightUnsigned((64 - 37))).xor(b2);
  b1 = b1.add(k3).add(t2);
  b0 = b0.add(b1).add(k2);
  b1 = (b1).shiftLeft(25).or(b1.shiftRightUnsigned((64 - 25))).xor(b0);
  b3 = b3.add(k0).add(Long.fromNumber(17));
  b2 = b2.add(b3).add(k4).add(t0);
  b3 = (b3).shiftLeft(33).or(b3.shiftRightUnsigned((64 - 33))).xor(b2);
  b0 = b0.add(b3);
  b3 = (b3).shiftLeft(46).or(b3.shiftRightUnsigned((64 - 46))).xor(b0);
  b2 = b2.add(b1);
  b1 = (b1).shiftLeft(12).or(b1.shiftRightUnsigned((64 - 12))).xor(b2);
  b0 = b0.add(b1);
  b1 = (b1).shiftLeft(58).or(b1.shiftRightUnsigned((64 - 58))).xor(b0);
  b2 = b2.add(b3);
  b3 = (b3).shiftLeft(22).or(b3.shiftRightUnsigned((64 - 22))).xor(b2);
  b0 = b0.add(b3);
  b3 = (b3).shiftLeft(32).or(b3.shiftRightUnsigned((64 - 32))).xor(b0);
  b2 = b2.add(b1);
  b1 = (b1).shiftLeft(32).or(b1.shiftRightUnsigned((64 - 32))).xor(b2);

  b0 = b0.add(k3);
  b1 = b1.add(k4).add(t0);  
  b2 = b2.add(k0).add(t1);
  b3 = b3.add(k1).add(Long.fromNumber(18));
    
  return putBytes([b0, b1, b2, b3], [], this.BlockSize);
}

var putBytes = TreeFish.putBytes = function(input, output, byteCount) {
  var j = 0;
  var offset = 0;
  
  for (var i = 0; i < byteCount; i++) {
    output[offset++] = input[i >> 3].shiftRight(j).and(Long.fromNumber(255)).toNumber()
    j = (j + 8) & 63;
  }  
  return output;
}

TreeFish.prototype.encryptBlock = function(input) {
}

TreeFish.prototype.decrypt = function(src, index) {
  index = index == null ? 0 : index;
  if(this.CIPHER_SIZE == 256) {
    return this.decryptBlock256(src.slice(index, index + this.BlockSize));
  }
}

TreeFish.prototype.decryptBlock256 = function(input) {
  // Unpack variables
  var b0 = Long.fromString(util.toHex(input.slice(0, 8).reverse()), 16);
  var b1 = Long.fromString(util.toHex(input.slice(8, 16).reverse()), 16);
  var b2 = Long.fromString(util.toHex(input.slice(16, 24).reverse()), 16);
  var b3 = Long.fromString(util.toHex(input.slice(24, 32).reverse()), 16);

  // Unpack key
  var k0 = this.expanedKey[0];
  var k1 = this.expanedKey  [1];
  var k2 = this.expanedKey[2];
  var k3 = this.expanedKey[3];
  var k4 = this.expanedKey[4];
  // Unpack tweak
  var t0 = this.expandedTweak[0];
  var t1 = this.expandedTweak[1];
  var t2 = this.expandedTweak[2];
  var tmp = Long.ZERO;  

  b0 = b0.subtract(k3);
  b1 = b1.subtract(k4.add(t0));
  b2 = b2.subtract(k0.add(t1));
  b3 = b3.subtract(k1.add(Long.fromNumber(18)));
  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(32).or(tmp.shiftLeft(64 - 32));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(32).or(tmp.shiftLeft(64 - 32));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(58).or(tmp.shiftLeft(64 - 58));
  b0 = b0.subtract(b1);
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(22).or(tmp.shiftLeft(64 - 22));
  b2 = b2.subtract(b3);
  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(46).or(tmp.shiftLeft(64 - 46));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(12).or(tmp.shiftLeft(64 - 12));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(25).or(tmp.shiftLeft(64 - 25));
  b0 = b0.subtract(b1.add(k2));
  b1 = b1.subtract(k3.add(t2));
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(33).or(tmp.shiftLeft(64 - 33));
  b2 = b2.subtract(b3.add(k4).add(t0));
  b3 = b3.subtract(k0.add(Long.fromNumber(17)));
  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(5).or(tmp.shiftLeft(64 - 5));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(37).or(tmp.shiftLeft(64 - 37));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(23).or(tmp.shiftLeft(64 - 23));
  b0 = b0.subtract(b1);
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(40).or(tmp.shiftLeft(64 - 40));
  b2 = b2.subtract(b3);
  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(52).or(tmp.shiftLeft(64 - 52));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(57).or(tmp.shiftLeft(64 - 57));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(14).or(tmp.shiftLeft(64 - 14));
  b0 = b0.subtract(b1.add(k1));
  b1 = b1.subtract(k2.add(t1));
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(16).or(tmp.shiftLeft(64 - 16));
  b2 = b2.subtract(b3.add(k3).add(t2));
  b3 = b3.subtract(k4.add(Long.fromNumber(16)));

  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(32).or(tmp.shiftLeft(64 - 32));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(32).or(tmp.shiftLeft(64 - 32));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(58).or(tmp.shiftLeft(64 - 58));
  b0 = b0.subtract(b1);
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(22).or(tmp.shiftLeft(64 - 22));
  b2 = b2.subtract(b3);
  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(46).or(tmp.shiftLeft(64 - 46));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(12).or(tmp.shiftLeft(64 - 12));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(25).or(tmp.shiftLeft(64 - 25));
  b0 = b0.subtract(b1.add(k0));
  b1 = b1.subtract(k1.add(t0));
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(33).or(tmp.shiftLeft(64 - 33));
  b2 = b2.subtract(b3.add(k2).add(t1));
  b3 = b3.subtract(k3.add(Long.fromNumber(15)));
  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(5).or(tmp.shiftLeft(64 - 5));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(37).or(tmp.shiftLeft(64 - 37));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(23).or(tmp.shiftLeft(64 - 23));
  b0 = b0.subtract(b1);
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(40).or(tmp.shiftLeft(64 - 40));
  b2 = b2.subtract(b3);
  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(52).or(tmp.shiftLeft(64 - 52));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(57).or(tmp.shiftLeft(64 - 57));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(14).or(tmp.shiftLeft(64 - 14));
  b0 = b0.subtract(b1.add(k4));
  b1 = b1.subtract(k0.add(t2));
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(16).or(tmp.shiftLeft(64 - 16));
  b2 = b2.subtract(b3.add(k1).add(t0));
  b3 = b3.subtract(k2.add(Long.fromNumber(14)));

  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(32).or(tmp.shiftLeft(64 - 32));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(32).or(tmp.shiftLeft(64 - 32));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(58).or(tmp.shiftLeft(64 - 58));
  b0 = b0.subtract(b1);
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(22).or(tmp.shiftLeft(64 - 22));
  b2 = b2.subtract(b3);
  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(46).or(tmp.shiftLeft(64 - 46));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(12).or(tmp.shiftLeft(64 - 12));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(25).or(tmp.shiftLeft(64 - 25));
  b0 = b0.subtract(b1.add(k3));
  b1 = b1.subtract(k4.add(t1));
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(33).or(tmp.shiftLeft(64 - 33));
  b2 = b2.subtract(b3.add(k0).add(t2));
  b3 = b3.subtract(k1.add(Long.fromNumber(13)));
  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(5).or(tmp.shiftLeft(64 - 5));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(37).or(tmp.shiftLeft(64 - 37));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(23).or(tmp.shiftLeft(64 - 23));
  b0 = b0.subtract(b1);
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(40).or(tmp.shiftLeft(64 - 40));
  b2 = b2.subtract(b3);
  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(52).or(tmp.shiftLeft(64 - 52));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(57).or(tmp.shiftLeft(64 - 57));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(14).or(tmp.shiftLeft(64 - 14));
  b0 = b0.subtract(b1.add(k2));
  b1 = b1.subtract(k3.add(t0));
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(16).or(tmp.shiftLeft(64 - 16));
  b2 = b2.subtract(b3.add(k4).add(t1));
  b3 = b3.subtract(k0.add(Long.fromNumber(12)));

  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(32).or(tmp.shiftLeft(64 - 32));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(32).or(tmp.shiftLeft(64 - 32));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(58).or(tmp.shiftLeft(64 - 58));
  b0 = b0.subtract(b1);
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(22).or(tmp.shiftLeft(64 - 22));
  b2 = b2.subtract(b3);
  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(46).or(tmp.shiftLeft(64 - 46));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(12).or(tmp.shiftLeft(64 - 12));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(25).or(tmp.shiftLeft(64 - 25));
  b0 = b0.subtract(b1.add(k1));
  b1 = b1.subtract(k2.add(t2));
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(33).or(tmp.shiftLeft(64 - 33));
  b2 = b2.subtract(b3.add(k3).add(t0));
  b3 = b3.subtract(k4.add(Long.fromNumber(11)));
  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(5).or(tmp.shiftLeft(64 - 5));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(37).or(tmp.shiftLeft(64 - 37));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(23).or(tmp.shiftLeft(64 - 23));
  b0 = b0.subtract(b1);
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(40).or(tmp.shiftLeft(64 - 40));
  b2 = b2.subtract(b3);
  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(52).or(tmp.shiftLeft(64 - 52));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(57).or(tmp.shiftLeft(64 - 57));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(14).or(tmp.shiftLeft(64 - 14));
  b0 = b0.subtract(b1.add(k0));
  b1 = b1.subtract(k1.add(t1));
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(16).or(tmp.shiftLeft(64 - 16));
  b2 = b2.subtract(b3.add(k2).add(t2));
  b3 = b3.subtract(k3.add(Long.fromNumber(10)));

  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(32).or(tmp.shiftLeft(64 - 32));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(32).or(tmp.shiftLeft(64 - 32));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(58).or(tmp.shiftLeft(64 - 58));
  b0 = b0.subtract(b1);
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(22).or(tmp.shiftLeft(64 - 22));
  b2 = b2.subtract(b3);
  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(46).or(tmp.shiftLeft(64 - 46));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(12).or(tmp.shiftLeft(64 - 12));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(25).or(tmp.shiftLeft(64 - 25));
  b0 = b0.subtract(b1.add(k4));
  b1 = b1.subtract(k0.add(t0));
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(33).or(tmp.shiftLeft(64 - 33));
  b2 = b2.subtract(b3.add(k1).add(t1));
  b3 = b3.subtract(k2.add(Long.fromNumber(9)));
  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(5).or(tmp.shiftLeft(64 - 5));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(37).or(tmp.shiftLeft(64 - 37));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(23).or(tmp.shiftLeft(64 - 23));
  b0 = b0.subtract(b1);
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(40).or(tmp.shiftLeft(64 - 40));
  b2 = b2.subtract(b3);
  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(52).or(tmp.shiftLeft(64 - 52));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(57).or(tmp.shiftLeft(64 - 57));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(14).or(tmp.shiftLeft(64 - 14));
  b0 = b0.subtract(b1.add(k3));
  b1 = b1.subtract(k4.add(t2));
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(16).or(tmp.shiftLeft(64 - 16));
  b2 = b2.subtract(b3.add(k0).add(t0));
  b3 = b3.subtract(k1.add(Long.fromNumber(8)));

  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(32).or(tmp.shiftLeft(64 - 32));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(32).or(tmp.shiftLeft(64 - 32));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(58).or(tmp.shiftLeft(64 - 58));
  b0 = b0.subtract(b1);
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(22).or(tmp.shiftLeft(64 - 22));
  b2 = b2.subtract(b3);
  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(46).or(tmp.shiftLeft(64 - 46));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(12).or(tmp.shiftLeft(64 - 12));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(25).or(tmp.shiftLeft(64 - 25));
  b0 = b0.subtract(b1.add(k2));
  b1 = b1.subtract(k3.add(t1));
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(33).or(tmp.shiftLeft(64 - 33));
  b2 = b2.subtract(b3.add(k4).add(t2));
  b3 = b3.subtract(k0.add(Long.fromNumber(7)));
  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(5).or(tmp.shiftLeft(64 - 5));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(37).or(tmp.shiftLeft(64 - 37));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(23).or(tmp.shiftLeft(64 - 23));
  b0 = b0.subtract(b1);
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(40).or(tmp.shiftLeft(64 - 40));
  b2 = b2.subtract(b3);
  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(52).or(tmp.shiftLeft(64 - 52));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(57).or(tmp.shiftLeft(64 - 57));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(14).or(tmp.shiftLeft(64 - 14));
  b0 = b0.subtract(b1.add(k1));
  b1 = b1.subtract(k2.add(t0));
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(16).or(tmp.shiftLeft(64 - 16));
  b2 = b2.subtract(b3.add(k3).add(t1));
  b3 = b3.subtract(k4.add(Long.fromNumber(6)));

  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(32).or(tmp.shiftLeft(64 - 32));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(32).or(tmp.shiftLeft(64 - 32));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(58).or(tmp.shiftLeft(64 - 58));
  b0 = b0.subtract(b1);
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(22).or(tmp.shiftLeft(64 - 22));
  b2 = b2.subtract(b3);
  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(46).or(tmp.shiftLeft(64 - 46));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(12).or(tmp.shiftLeft(64 - 12));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(25).or(tmp.shiftLeft(64 - 25));
  b0 = b0.subtract(b1.add(k0));
  b1 = b1.subtract(k1.add(t2));
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(33).or(tmp.shiftLeft(64 - 33));
  b2 = b2.subtract(b3.add(k2).add(t0));
  b3 = b3.subtract(k3.add(Long.fromNumber(5)));
  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(5).or(tmp.shiftLeft(64 - 5));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(37).or(tmp.shiftLeft(64 - 37));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(23).or(tmp.shiftLeft(64 - 23));
  b0 = b0.subtract(b1);
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(40).or(tmp.shiftLeft(64 - 40));
  b2 = b2.subtract(b3);
  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(52).or(tmp.shiftLeft(64 - 52));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(57).or(tmp.shiftLeft(64 - 57));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(14).or(tmp.shiftLeft(64 - 14));
  b0 = b0.subtract(b1.add(k4));
  b1 = b1.subtract(k0.add(t1));
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(16).or(tmp.shiftLeft(64 - 16));
  b2 = b2.subtract(b3.add(k1).add(t2));
  b3 = b3.subtract(k2.add(Long.fromNumber(4)));

  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(32).or(tmp.shiftLeft(64 - 32));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(32).or(tmp.shiftLeft(64 - 32));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(58).or(tmp.shiftLeft(64 - 58));
  b0 = b0.subtract(b1);
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(22).or(tmp.shiftLeft(64 - 22));
  b2 = b2.subtract(b3);
  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(46).or(tmp.shiftLeft(64 - 46));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(12).or(tmp.shiftLeft(64 - 12));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(25).or(tmp.shiftLeft(64 - 25));
  b0 = b0.subtract(b1.add(k3));
  b1 = b1.subtract(k4.add(t0));
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(33).or(tmp.shiftLeft(64 - 33));
  b2 = b2.subtract(b3.add(k0).add(t1));
  b3 = b3.subtract(k1.add(Long.fromNumber(3)));
  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(5).or(tmp.shiftLeft(64 - 5));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(37).or(tmp.shiftLeft(64 - 37));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(23).or(tmp.shiftLeft(64 - 23));
  b0 = b0.subtract(b1);
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(40).or(tmp.shiftLeft(64 - 40));
  b2 = b2.subtract(b3);
  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(52).or(tmp.shiftLeft(64 - 52));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(57).or(tmp.shiftLeft(64 - 57));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(14).or(tmp.shiftLeft(64 - 14));
  b0 = b0.subtract(b1.add(k2));
  b1 = b1.subtract(k3.add(t2));
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(16).or(tmp.shiftLeft(64 - 16));
  b2 = b2.subtract(b3.add(k4).add(t0));
  b3 = b3.subtract(k0.add(Long.fromNumber(2)));

  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(32).or(tmp.shiftLeft(64 - 32));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(32).or(tmp.shiftLeft(64 - 32));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(58).or(tmp.shiftLeft(64 - 58));
  b0 = b0.subtract(b1);
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(22).or(tmp.shiftLeft(64 - 22));
  b2 = b2.subtract(b3);
  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(46).or(tmp.shiftLeft(64 - 46));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(12).or(tmp.shiftLeft(64 - 12));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(25).or(tmp.shiftLeft(64 - 25));
  b0 = b0.subtract(b1.add(k1));
  b1 = b1.subtract(k2.add(t1));
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(33).or(tmp.shiftLeft(64 - 33));
  b2 = b2.subtract(b3.add(k3).add(t2));
  b3 = b3.subtract(k4.add(Long.fromNumber(1)));
  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(5).or(tmp.shiftLeft(64 - 5));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(37).or(tmp.shiftLeft(64 - 37));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(23).or(tmp.shiftLeft(64 - 23));
  b0 = b0.subtract(b1);
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(40).or(tmp.shiftLeft(64 - 40));
  b2 = b2.subtract(b3);
  tmp = b3.xor(b0);
  b3 = tmp.shiftRightUnsigned(52).or(tmp.shiftLeft(64 - 52));
  b0 = b0.subtract(b3);
  tmp = b1.xor(b2);
  b1 = tmp.shiftRightUnsigned(57).or(tmp.shiftLeft(64 - 57));
  b2 = b2.subtract(b1);
  tmp = b1.xor(b0);
  b1 = tmp.shiftRightUnsigned(14).or(tmp.shiftLeft(64 - 14));
  b0 = b0.subtract(b1.add(k0));
  b1 = b1.subtract(k1.add(t0));
  tmp = b3.xor(b2);
  b3 = tmp.shiftRightUnsigned(16).or(tmp.shiftLeft(64 - 16));
  b2 = b2.subtract(b3.add(k2).add(t1));
  b3 = b3.subtract(k3);

  return putBytes([b0, b1, b2, b3], [], this.BlockSize);
}

